<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
    <script src="zepto.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular-route.js"></script>
    <script type="text/javascript" src="angular-filter.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        td {
            margin: 0;
            padding: 0;
            border-right: dashed 1px;
        }

        .circle {
            border-radius: 50%;
            display: inline-block;
            margin-right: 20px;
            width: 10px;
            height: 10px;
        }

        .checked {
            background-image: url("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Red_check.svg/600px-Red_check.svg.png");
            background-size: 10px 10px;
        }

        .circleActive {
            background-color: green;
        }

        .circleAway {
            background-color: goldenrod;
        }
    </style>
    <script src="socket.js"></script>
    <script>
        var app = angular.module('remoting', ['ngRoute', 'btford.socket-io', 'angular.filter']);

        app.factory('socket', function (socketFactory) {
            return socketFactory({
                ioSocket: io.connect('https://rpc.ventra.ru/')
            });
        });

        app.config(function ($routeProvider, $locationProvider) {
            $routeProvider
                    .when('/', {
                        templateUrl: 'in.html',
                        controller: 'homeCtrl'
                    })
                    .when('/client/:clientid', {
                        templateUrl: 'client.html',
                        controller: 'clientCtrl',
                        resolve: {
                            delay: function ($q, $timeout) {
                                var delay = $q.defer();
                                $timeout(delay.resolve, 500);
                                return delay.promise;
                            }
                        }
                    })
                    .otherwise({redirectTo: '/'});

            $locationProvider.html5Mode({
                enabled: false,
                requireBase: false
            });
        });

        app.controller('mainCtrl', function ($scope, $location, socket) {
            socket.on('message', function (data) {
                console.log(data);
            });

            socket.on('connect', function () {
                socket.emit('supervisor');
//                $location.path("/");
            });
        });

        app.controller('clientCtrl', function ($scope, $routeParams, $location, socket) {
            socket.emit("supervise", $routeParams.clientid);
            socket.on('screen', function (data) {
                var doc = document.getElementById('frame').contentWindow.document;
                doc.open();
                doc.write(data);
                doc.close();
                $(doc).find('[scrollTop],[scrollLeft]').each(function () {
                    $(this).scrollTop($(this).attr("scrollTop"));
                    $(this).scrollLeft($(this).attr("scrollLeft"));
                });
                $(doc).find('body').width($(doc).find('body').attr('absWidth'));
                $(doc).find('body').height($(doc).find('body').attr('absHeight'));
                var xScale = $('body').width() / $(doc).find('body').width();
                var yScale = $('body').height() / $(doc).find('body').height();
                $('#frame').width($(doc).find('body').width());
                $('#frame').height($(doc).find('body').height());
//                $('#frame').css('transform', 'scale('+xScale+', '+yScale+')');
//                $('#frame').css('transform-origin', 'top left');
            });
            socket.on("disconnected", function () {
                $location.path("/");
            });

            $scope.disconnect = function () {
                socket.emit("unsupervise");
            };
        });
        app.controller('homeCtrl', function ($scope, $routeParams, $location, socket) {
            socket.emit('supervisor');

            $scope.data = {order: 'info.active', reverseOrder: true, clients: {}, connectedTo: [], page: 0};

            socket.on('client_updated', function (data) {
                $scope.data.clients[data.uuid] = data;
            });
            
            socket.on('connected_to', function(uuid){
                $scope.data.connectedTo.push(uuid);
            });

            socket.on('disconnected_from', function(uuid){
                $scope.data.connectedTo.splice($scope.data.connectedTo.indexOf(uuid), 1)
            });
            
            $scope.connected = function(uuid) {
                return $scope.data.connectedTo.indexOf(uuid) !== -1;
            };

            $scope.updateOrder = function (order) {
                if ($scope.data.order === order) {
                    $scope.data.reverseOrder = !$scope.data.reverseOrder;
                    return;
                }

                $scope.data.order = order;
                $scope.data.reverseOrder = true;
            };

            socket.on('client_disconnected', function (data) {
                delete $scope.data.clients[data];
            });

            $scope.connect = function (clientid) {
                $location.path("/client/" + clientid);
            };
            $scope.toggleConnection = function (clientid) {
                socket.emit('toggle_connect', clientid);
            };
            $scope.toggleAll = function () {
                $scope.data.clients.forEach(function (client) {
                    socket.emit('toggle_connect', client.uuid);
                });
            };
            $scope.reload = function () {
                socket.emit("requestreload");
            };
            $scope.ping = function () {
                socket.emit("requestping");
            };

            $scope.sendMessage = function (title, message, type) {
                socket.emit("showmessage", {title: title, message: message, type: type});
            };

            $scope.countdown = function (time) {
                socket.emit("countdown", time);
            };
        });
    </script>
</head>
<body ng-app="remoting" ng-controller="mainCtrl">
<!--<div style="margin:0; padding:0;width: 100%; height: 50px;"></div>-->
<div ng-view style="height: 100%; width: 100%;"></div>
</body>
</html>